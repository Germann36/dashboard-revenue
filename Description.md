# Дашборд "Выручка – Билеты на выставки – Q3"
![Дашборд](images/dash.png)

## Техническое описание
- Дашборд был сделан в облачной BI-системе Yandex DataLens. 
- Основным источником данных является выгрузка из билетной системы в csv, загружаемая напрямую в DataLens. 
  - *В ближайшей перспективе источник данных будет загружаться по API в облачное хранилище Object Storage и подключаться к BI-системе через Yandex Query.*
  - *В дальнейшем планируется развитие собственного DWH на основе ClickHouse.*
- Для модели данных были подготовлены бизнес-справочники. Также был добавлен календарь с целью масштабирования аналитики. Например, для подключения таблицы с плановыми показателями. 

![Модель данных](images/olap.png)
*Схема модели данных*

## Метрики
![Карта метрик](images/metric-map.png)
### Фактические
- **Выручка (руб)**: суммарная выручка от продажи билетов [Цена билета * Кол-во билетов в чеке].
- **Чеки (шт)**: общее количество оформленных чеков. 
- **Билеты (шт)**: общее количество проданных билетов. 

### Расчетные
- **Средний чек (руб)**: средняя сумма одного заказа [Выручка (руб) / Чеки (шт)]
- **Ср. стоимость билета (руб)**: средняя цена одного билета [Выручка (руб) / Билеты (шт)]
- **Ср. билетов в чеке (шт)**: среднее количество билетов в чеке [Билеты (шт) / Чеки (шт)]

#### *Примечание*
*Метрики можно было назвать по общепринятой терминологии. Например, средний чек – AOV, количество позиций в чеке – UPT и так далее. Однако в сфере культуры и искусства такие наименования не распространены.*

## Настройка чартов
### Как подписать недельные максимумы на графике
![Чарт 1](images/chart-1.png)
```sql
IF 
    MAX([sum_value] WITHIN WEEK([datetrunc_date])) --Оконка для вычисления максимального дохода за неделю
    = [sum_value] --Сравниваем результат оконки с доходом за день
        THEN [sum_value] --Если совпадет – выводим значение
    ELSE NULL --Если нет – оставляем пустым
END
```

### Как сделать кастомные подписи на кольцевой диаграмме
![Чарт 2](images/chart-2.png)
```sql
[domain_place] --Название специализации
+ ": " 
+ STR( 
    ROUND(
        SUM([value]) / SUM(SUM([value]) TOTAL) * 100 --Доля
        )) 
+ "%"
```

### Как определить кумулятивный итог, топ и квартили для точечной диаграммы
![Чарт 3](images/chart-3.png)

Сначала проранжируем галереи по выручке
```sql
RANK_DENSE(SUM([value]) WITHIN [datetrunc_date]) --используем rank_dense, чтобы не было пропусков
```

Теперь посчитаем накопительный итог
```sql
RSUM([Доля в выручке] ORDER BY [Доля в выручке] ASC)
```

Разделим по квартилям куммулятивный итог
```sql
    IF [w. Кум.дол.итог] <= 0.25 THEN "1"
ELSEIF [w. Кум.дол.итог] <= 0.5 THEN "2"
ELSEIF [w. Кум.дол.итог] <= 0.75 THEN "3"
ELSEIF [w. Кум.дол.итог] <= 1 THEN "4" 
END
```

## Планы
- Развернуть ClickHouse в Yandex Cloud и настроить ETL с билетной системой. 
- Подключить DataLens к ClickHouse и перенести расчёты на СУБД.
